{% extends "base.html" %}
{% load staticfiles %}
{% block head %}
<script src="{% static 'd3/d3.js' %}"></script>
<style type="text/css">
    #tooltip {
        -moz-transition: all 0.15s;
        -o-transition: all 0.15s;
        -webkit-transition: all 0.15s;
        transition: all 0.15s;
        opacity: 0.90;
        position: absolute;
        min-width: 60px;
        height: auto;
        padding: 10px;
        background-color: white;
        -webkit-border-radius: 5px;
        -moz-border-radius: 5px;
        border-radius: 5px;
        -webkit-box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.4);
        -moz-box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.4);
        box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.4);
        pointer-events: none;
    }

    #tooltip.hidden {
        display: none;
    }

    #tooltip p {
        margin: 0;
        font-family: sans-serif;
        font-size: 16px;
        line-height: 20px;
    }
    path:hover {
        opacity: 0.9;
        transition-duration: 0.2s;
    }
</style>
{% endblock %}

{% block content %}
<h2>Arizona Mood Map by County</h2>
<div id="tooltip" class="hidden">
    <p><span id="county-label"></span></p>
</div>
<div id="az-county-map"></div>
<script type="text/javascript">
    //Width and height
    var w = 500;
    var h = 500;
    //Define Arizona map projection
    var projection = d3.geo.albers()
                           .scale([4500])
                           .rotate([108, 0, 0])
                           .translate([450, -100])
                           ;
    //Define path generator
    var path = d3.geo.path()
                     .projection(projection);

    //Define scale to sort data values into buckets of color
    var color = d3.scale.quantize()
                        .range(["rgb(247,252,253)","rgb(229,245,249)","rgb(204,236,230)","rgb(153,216,201)","rgb(102,194,164)","rgb(65,174,118)","rgb(35,139,69)","rgb(0,109,44)","rgb(0,68,27)"]);
                        //Colors taken from colorbrewer.js
    //Create SVG element
    var svg = d3.select("#az-county-map")
                .append("svg")
                .attr("width", w)
                .attr("height", h);

    //Load in tweet data

    jsonStr = "{{ data }}";
    jsonStr = jsonStr.replace(/&quot;/g,'"');

    data = JSON.parse(jsonStr);

    //Set input domain for color scale
    color.domain([
        d3.min(data, function(d) { return -0.00; }),
        d3.max(data, function(d) { return +0.50; })
    ]);

    //Load in GeoJSON data
    d3.json("{% static 'maps/us-arizona-counties.json' %}", function(json) {
        //Merge the pop. data and GeoJSON
        //Loop through once for each pop. data value
        for (var i = 0; i < data.length; i++) {

            //Grab county name
            var dataCounty = data[i].county;

            //Grab data value, and convert from string to float
            var dataValue = parseFloat(data[i].count);

            //Find the corresponding county inside the GeoJSON
            for (var j = 0; j < json.features.length; j++) {

                var jsonCounty = json.features[j].properties.name;

                if (dataCounty == jsonCounty) {

                    //Copy the data value into the JSON
                    json.features[j].properties.value = dataValue;

                    //Stop looking through the JSON
                    break;

                }
            }
        }
        //Bind data and create one path per GeoJSON feature
        svg.selectAll("path")
           .data(json.features)
           .enter()
           .append("path")
           .attr("d", path)
           .style("stroke","#ccc")
           .style("fill", function(d) {
                //Get data value
                var value = d.properties.value;

                if (value) {
                    //If value exists…
                    return color(value);
                } else {
                    //If value is undefined…
                    return "#ccc";
                }
           })
           .on("mouseover", function(d) {   //Add tooltip on mouseover for each circle
                    //Get this county's x/y values, then augment for the tooltip
                    var xPosition = d3.select(this).attr("x");
                    var yPosition = d3.select(this).attr("y");
                    //Update the tooltip position and value
                    d3.select("#tooltip")
                        //Show the tooltip above where the mouse triggers the event
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY - 70) + "px")
                        .select("#county-label")
                        //Input data has been bound to JSON at this point - so values must be referenced from JSON properties
                        .html("<strong>" + d.properties.name + "</strong>" + "<br/>" + "Mood Index: " + d.properties.value)

                    //Show the tooltip
                    d3.select("#tooltip").classed("hidden", false);
               })
               .on("mouseout", function() {

                    //Hide the tooltip
                    d3.select("#tooltip").classed("hidden", true);
               })
     });
</script>

<hr>

<h3>About this map</h3>

<p>This map displays the the mood of people in every county in the state of
    Arizona based on twitter feeds originated in the state.</p>

<hr>
<table>
    <tr>
        <th align="left">County</th>
        <th>Tweet Count</th>
    </tr>
    {% for dict in tweet_stats %}
    <tr>

        {% for key, value in dict.items %}
        <td> {{ value }}</td>
        {% endfor %}

    </tr>
    {% endfor %}
</table>

{% endblock %}